<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.start.webBack.mapper.ChargePileDetailMapper">
	<!--  -->
	
	
	<!--  -->
	<!-- 查询充电桩用户使用数量 -->
	<select id = "getUserChargeCount" parameterType = "FindCPDto" resultType = "int">
			SELECT COUNT(*) FROM(SELECT
						  CPINFO.CPUSERNAME,
						  CPINFO.PLATENUMBER,
						  CPINFO.TELEPHONE,
						  LEFT(UCORD.CHARGESTARTTIME,19)CHARGESTARTTIME,
						  FROM_UNIXTIME((UNIX_TIMESTAMP(UCORD.CHARGESTARTTIME)+UCORD.CHARGETIMESPAN),'%Y-%m-%d %H:%i:%S')    CHARGEENDTIME,
						  CONCAT(SUBSTR(SEC_TO_TIME(UCORD.CHARGETIMESPAN),1,2),"小时", SUBSTR(SEC_TO_TIME(UCORD.CHARGETIMESPAN),4,2),"分",SUBSTR(SEC_TO_TIME(UCORD.CHARGETIMESPAN),7),"秒")CHARGETIMESPAN,
						  UCORD.CHARGEQUANTITY,
						  UCORD.CHARGEMONEY,
						  UCORD.SERVICETIP
						FROM USERCHARGERECORD UCORD,
						  CPUSERINFO CPINFO
						WHERE CPINFO.CPUSERID = UCORD.CPUSERID
						AND UCORD.CPID = #{CPID}
						AND UCORD.CHARGEMETHODID = 0
						GROUP BY UCORD.CHARGESTARTTIME				
						
					UNION ALL
					SELECT
							  CARD.CARDUSERNAME CPUSERNAME,
							  CARD.PLATENUM PLATENUMBER ,
							  CARD.TELEPHONE,
							  LEFT(UCORD.CHARGESTARTTIME,19)CHARGESTARTTIME,
							  FROM_UNIXTIME((UNIX_TIMESTAMP(UCORD.CHARGESTARTTIME)+UCORD.CHARGETIMESPAN),'%Y-%m-%d %H:%i:%S')    CHARGEENDTIME,
							  CONCAT(SUBSTR(SEC_TO_TIME(UCORD.CHARGETIMESPAN),1,2),"小时", SUBSTR(SEC_TO_TIME(UCORD.CHARGETIMESPAN),4,2),"分",SUBSTR(SEC_TO_TIME(UCORD.CHARGETIMESPAN),7),"秒")CHARGETIMESPAN,
							  UCORD.CHARGEQUANTITY,
							  UCORD.CHARGEMONEY,
							  UCORD.SERVICETIP
							FROM USERCHARGERECORD UCORD,
							  CARDUSERINFO CARD
							WHERE CARD.CARDNUM = UCORD.CARDNUM
							AND UCORD.CPID = #{CPID}
							AND UCORD.CHARGEMETHODID = 1
							GROUP BY UCORD.CHARGESTARTTIME				
							)A 
							WHERE 1=1
						<if test="FROMDATE!=null and FROMDATE!=''">
					    AND
								 STR_TO_DATE(A.CHARGESTARTTIME, '%Y-%m-%d %H:%i') &gt;= #{FROMDATE}
						</if>
						<if test="TODATE!=null and TODATE!=''">
						AND
								 STR_TO_DATE(A.CHARGESTARTTIME, '%Y-%m-%d %H:%i') &lt;= #{TODATE}
						</if>	
							
	</select>
	
	<!-- 查询运营信息 -->
	<select id = "selectOperInfo" parameterType = "FindCPDto" resultType = "OperInfoDto">
		SELECT
		  CP.CPID,
		  CP.CPNAME,
		  COUNT(CP.CPID)CPCOUNT,
		  ROUND(SUM(UCORD.CHARGEQUANTITY),4)    CHARGEQUANTITY,
		  ROUND(SUM(UCORD.CHARGEMONEY),4)    CHARGEMONEY,
		  ROUND(SUM(UCORD.SERVICETIP),4)    SERVICETIP
		FROM CPINFO CP,
		  USERCHARGERECORD UCORD,CPUSERINFO CPINFO
		WHERE CP.CPID = UCORD.CPID
		AND CPINFO.CPUSERID = UCORD.CPUSERID
		AND CP.CPID = #{CPID}
		<if test="FROMDATE!=null and FROMDATE!=''">
	    AND
				 STR_TO_DATE(UCORD.CHARGESTARTTIME, '%Y-%m-%d %H:%i') &gt;= #{FROMDATE}
		</if>
		<if test="TODATE!=null and TODATE!=''">
		AND
				 STR_TO_DATE(UCORD.CHARGESTARTTIME, '%Y-%m-%d %H:%i') &lt;= #{TODATE}
		</if>		
		GROUP BY CP.CPID
	</select>
	
	
	<!-- 查询充电桩用户使用详细 -->
	<select id = "selectexportChargeDetail" parameterType = "FindCPDto" resultType = "UserChargeDto">
				SELECT * FROM(SELECT
						  CPINFO.CPUSERNAME,
						  CPINFO.PLATENUMBER,
						  CPINFO.TELEPHONE,
						  LEFT(UCORD.CHARGESTARTTIME,19)CHARGESTARTTIME,
						  FROM_UNIXTIME((UNIX_TIMESTAMP(UCORD.CHARGESTARTTIME)+UCORD.CHARGETIMESPAN),'%Y-%m-%d %H:%i:%S')    CHARGEENDTIME,
						  CONCAT(SUBSTR(SEC_TO_TIME(UCORD.CHARGETIMESPAN),1,2),"小时", SUBSTR(SEC_TO_TIME(UCORD.CHARGETIMESPAN),4,2),"分",SUBSTR(SEC_TO_TIME(UCORD.CHARGETIMESPAN),7),"秒")CHARGETIMESPAN,
						  UCORD.CHARGEQUANTITY,
						  UCORD.CHARGEMONEY,
						  UCORD.SERVICETIP
						FROM USERCHARGERECORD UCORD,
						  CPUSERINFO CPINFO
						WHERE CPINFO.CPUSERID = UCORD.CPUSERID
						AND UCORD.CPID = #{CPID}
						AND UCORD.CHARGEMETHODID = 0
						GROUP BY UCORD.CHARGESTARTTIME	
					UNION ALL
					SELECT
							  CARD.CARDUSERNAME CPUSERNAME,
							  CARD.PLATENUM PLATENUMBER ,
							  CARD.TELEPHONE,
							  LEFT(UCORD.CHARGESTARTTIME,19)CHARGESTARTTIME,
							  FROM_UNIXTIME((UNIX_TIMESTAMP(UCORD.CHARGESTARTTIME)+UCORD.CHARGETIMESPAN),'%Y-%m-%d %H:%i:%S')    CHARGEENDTIME,
							  CONCAT(SUBSTR(SEC_TO_TIME(UCORD.CHARGETIMESPAN),1,2),"小时", SUBSTR(SEC_TO_TIME(UCORD.CHARGETIMESPAN),4,2),"分",SUBSTR(SEC_TO_TIME(UCORD.CHARGETIMESPAN),7),"秒")CHARGETIMESPAN,
							  UCORD.CHARGEQUANTITY,
							  UCORD.CHARGEMONEY,
							  UCORD.SERVICETIP
							FROM USERCHARGERECORD UCORD,
							  CARDUSERINFO CARD
							WHERE CARD.CARDNUM = UCORD.CARDNUM
							AND UCORD.CPID = #{CPID}
							AND UCORD.CHARGEMETHODID = 1
							GROUP BY UCORD.CHARGESTARTTIME)A
							WHERE 1=1
						<if test="FROMDATE!=null and FROMDATE!=''">
					    AND
								 STR_TO_DATE(A.CHARGESTARTTIME, '%Y-%m-%d %H:%i') &gt;= #{FROMDATE}
						</if>
						<if test="TODATE!=null and TODATE!=''">
						AND
								 STR_TO_DATE(A.CHARGESTARTTIME, '%Y-%m-%d %H:%i') &lt;= #{TODATE}
						</if>
	</select>
	<!-- 查询充电桩用户使用详细 -->
	<select id = "selectCpCharge" parameterType = "FindCPDto" resultType = "UserChargeDto">
		SELECT * FROM(SELECT
						  CPINFO.CPUSERNAME,
						  CPINFO.PLATENUMBER,
						  CPINFO.TELEPHONE,
						  LEFT(UCORD.CHARGESTARTTIME,19)CHARGESTARTTIME,
						  FROM_UNIXTIME((UNIX_TIMESTAMP(UCORD.CHARGESTARTTIME)+UCORD.CHARGETIMESPAN),'%Y-%m-%d %H:%i:%S')    CHARGEENDTIME,
						  CONCAT(SUBSTR(SEC_TO_TIME(UCORD.CHARGETIMESPAN),1,2),"小时", SUBSTR(SEC_TO_TIME(UCORD.CHARGETIMESPAN),4,2),"分",SUBSTR(SEC_TO_TIME(UCORD.CHARGETIMESPAN),7),"秒")CHARGETIMESPAN,
						  UCORD.CHARGEQUANTITY,
						  UCORD.CHARGEMONEY,
						  UCORD.SERVICETIP
						FROM USERCHARGERECORD UCORD,
						  CPUSERINFO CPINFO
						WHERE CPINFO.CPUSERID = UCORD.CPUSERID
						AND UCORD.CPID = #{CPID}
						AND UCORD.CHARGEMETHODID = 0
						GROUP BY UCORD.CHARGESTARTTIME	
					UNION ALL
					SELECT
							  CARD.CARDUSERNAME CPUSERNAME,
							  CARD.PLATENUM PLATENUMBER ,
							  CARD.TELEPHONE,
							  LEFT(UCORD.CHARGESTARTTIME,19)CHARGESTARTTIME,
							  FROM_UNIXTIME((UNIX_TIMESTAMP(UCORD.CHARGESTARTTIME)+UCORD.CHARGETIMESPAN),'%Y-%m-%d %H:%i:%S')    CHARGEENDTIME,
							  CONCAT(SUBSTR(SEC_TO_TIME(UCORD.CHARGETIMESPAN),1,2),"小时", SUBSTR(SEC_TO_TIME(UCORD.CHARGETIMESPAN),4,2),"分",SUBSTR(SEC_TO_TIME(UCORD.CHARGETIMESPAN),7),"秒")CHARGETIMESPAN,
							  UCORD.CHARGEQUANTITY,
							  UCORD.CHARGEMONEY,
							  UCORD.SERVICETIP
							FROM USERCHARGERECORD UCORD,
							  CARDUSERINFO CARD
							WHERE CARD.CARDNUM = UCORD.CARDNUM
							AND UCORD.CPID = #{CPID}
							AND UCORD.CHARGEMETHODID = 1
							GROUP BY UCORD.CHARGESTARTTIME)A
							WHERE 1=1
						<if test="FROMDATE!=null and FROMDATE!=''">
					    AND
								 STR_TO_DATE(A.CHARGESTARTTIME, '%Y-%m-%d %H:%i') &gt;= #{FROMDATE}
						</if>
						<if test="TODATE!=null and TODATE!=''">
						AND
								 STR_TO_DATE(A.CHARGESTARTTIME, '%Y-%m-%d %H:%i') &lt;= #{TODATE}
						</if>
						LIMIT
						#{startPos},#{pageSize}
		
		
	</select>
	<!-- 
	//MODIFIED BY HANMJ 20170717 BEGIN -->
		<!-- 查询充电桩信息详情 -->
	<!-- 
	<select id="selectCPDetail" parameterType = "FindCPDto" resultType="CPInfoDto">
		SELECT
				CP.CPID,
				CPNAME,
				CO.OPERATORNAME,
				CS.CSNAME,								
				MFR.MFRNAME,
				CP.MODEL,
				LEFT(CP.CREATETIME,19) CREATETIME,	
				CP.IPADDRESS,
				CP.PORT,		
				COMMCYCLE,
				SAVECYCLE,
					CASE CP.ALARMFLAG
					WHEN 0 THEN '禁用'
					ELSE '启用'END
				ALARMFLAG,
					CASE CP.SAVEFLAG
					WHEN 0 THEN '不入库'
					ELSE '入库'END
				SAVEFLAG,
					CASE CP.VALIDFLAG
					WHEN 0 THEN '不可用'
					ELSE '可用' END
				VALIDFLAG,
				RATEID,
				STATENAME CPCURRSTATE,
				PROTOCOLNAME,
				CONCAT(PRO.PROVINCENAME,CITY.CITYNAME,AREA.AREANAME,ADDRESS.ADDRESSNAME)LOCATION
		FROM
				PROVINCE PRO,
				CITY,
				AREA,
				ADDRESS,
				CPINFO CP,
				OPERATORINFO CO,
				CSINFO CS,
				CPMFRINFO MFR,
				PROTOCOLINFO INFO,
				CPSTATETYPE TYPE
		WHERE		
				INFO.PROTOCOLID = CP.PROTOCOLID
		AND
				CP.OPERATORID = CO.OPERATORID
		AND
				PRO.PROVINCEID = CITY.PROVINCEID
		AND
				CITY.CITYID = AREA.CITYID
		AND
				AREA.AREAID = ADDRESS.AREAID
		AND
				CP.ADDRESSID=ADDRESS.ADDRESSID
		AND
				CP.CSID=CS.CSID
		AND
				CP.MFRID =MFR.MFRID
		<if test="CPID!=null and CPID!=''">
		AND
				 CP.CPID = #{CPID}
		</if>		
	</select>	-->
	<select id="selectCPDetail" parameterType = "FindCPDto" resultType="CPInfoDto">
		SELECT
				CP.CPID,
				CPNAME,
				CO.OPERATORNAME,
				CS.CSNAME,								
				MFR.MFRNAME,
				CP.MODEL,
				LEFT(CP.CREATETIME,19) CREATETIME,	
				CP.VALIDFLAG,
				RATEID,
				STATENAME CPCURRSTATE,
				PROTOCOLNAME,
				CONCAT(PRO.PROVINCENAME,CITY.CITYNAME,AREA.AREANAME,ADDRESS.ADDRESSNAME)LOCATION
		FROM
				PROVINCE PRO,
				CITY,
				AREA,
				ADDRESS,
				CPINFO CP,
				OPERATORINFO CO,
				CSINFO CS,
				CPMFRINFO MFR,
				PROTOCOLINFO INFO,
				CPSTATETYPE TYPE
		WHERE		
				INFO.PROTOCOLID = CP.PROTOCOLID
		AND
				CP.OPERATORID = CO.OPERATORID
		AND
				PRO.PROVINCEID = CITY.PROVINCEID
		AND
				CITY.CITYID = AREA.CITYID
		AND
				AREA.AREAID = ADDRESS.AREAID
		AND
				CP.ADDRESSID=ADDRESS.ADDRESSID
		AND
				CP.CSID=CS.CSID
		AND
				CP.MFRID =MFR.MFRID
		<if test="CPID!=null and CPID!=''">
		AND
				 CP.CPID = #{CPID}
		</if>		
	</select>
	<!--MODIFIED BY HANMJ 20170717 END -->
	
</mapper>
